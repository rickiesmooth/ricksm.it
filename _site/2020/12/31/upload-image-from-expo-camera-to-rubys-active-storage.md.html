<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Upload Image from Expo Camera to Ruby’s Active Storage | Ricksm.it</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Upload Image from Expo Camera to Ruby’s Active Storage" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="For an Expo project I’m working on, we needed to upload an image captured by Expo’s Camera with Ruby’s Active Storage and store the files on Amazon S3. For the web you can just use the @rails/activestorage package to handle the upload process, but this doesn’t work on React Native, so I was searching SO for alternatives to do this (this GitHub comment explains exactly what I needed to do)." />
<meta property="og:description" content="For an Expo project I’m working on, we needed to upload an image captured by Expo’s Camera with Ruby’s Active Storage and store the files on Amazon S3. For the web you can just use the @rails/activestorage package to handle the upload process, but this doesn’t work on React Native, so I was searching SO for alternatives to do this (this GitHub comment explains exactly what I needed to do)." />
<link rel="canonical" href="http://localhost:4000/2020/12/31/upload-image-from-expo-camera-to-rubys-active-storage.md.html" />
<meta property="og:url" content="http://localhost:4000/2020/12/31/upload-image-from-expo-camera-to-rubys-active-storage.md.html" />
<meta property="og:site_name" content="Ricksm.it" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-31T15:08:59+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Upload Image from Expo Camera to Ruby’s Active Storage" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-12-31T15:08:59+01:00","datePublished":"2020-12-31T15:08:59+01:00","description":"For an Expo project I’m working on, we needed to upload an image captured by Expo’s Camera with Ruby’s Active Storage and store the files on Amazon S3. For the web you can just use the @rails/activestorage package to handle the upload process, but this doesn’t work on React Native, so I was searching SO for alternatives to do this (this GitHub comment explains exactly what I needed to do).","headline":"Upload Image from Expo Camera to Ruby’s Active Storage","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/12/31/upload-image-from-expo-camera-to-rubys-active-storage.md.html"},"url":"http://localhost:4000/2020/12/31/upload-image-from-expo-camera-to-rubys-active-storage.md.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ricksm.it" /></head><body><header class="site-header">

    <div class="wrapper"><a class="site-title" rel="author" href="/">Ricksm.it</a></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Upload Image from Expo Camera to Ruby&#39;s Active Storage </h1>
    <p class="post-meta"><time class="dt-published" datetime="2020-12-31T15:08:59+01:00" itemprop="datePublished">
        Dec 31, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>For an Expo project I’m working on, we needed to upload an image captured by Expo’s Camera with Ruby’s Active Storage and store the files on Amazon S3. For the web you can just use the <code class="language-plaintext highlighter-rouge">@rails/activestorage</code> package to handle the upload process, but this doesn’t work on React Native, so I was searching SO for alternatives to do this (<a href="https://github.com/rails/rails/issues/32208#issuecomment-383737803">this</a> GitHub comment explains exactly what I needed to do).</p>

<p>Such a trivial task, wasn’t as straightforward as I’d hoped because when you request the signed upload URL, you need to provide a base64-encoded MD5 checksum that matches the file that you will upload to that signed upload URL. When you use <code class="language-plaintext highlighter-rouge">@rails/activestorage</code>, it uses <code class="language-plaintext highlighter-rouge">FileReader.readAsArrayBuffer</code> to calculate the checksum incrementally, which isn’t available on React Native so you need to calculate this yourself.</p>

<p>A workaround that was mentioned around the web was to use <code class="language-plaintext highlighter-rouge">rn-fetch-blob</code>, which generates a hash of the file that can be encoded in base64. Unfortunately the package was deprecated, and I was hoping not to add another dependency just to fetch a blob and generate a checksum since Expo already provides you with the MD5 hash of a file with <code class="language-plaintext highlighter-rouge">expo-file-system</code>.</p>

<p>In my first attempts I tried to use <code class="language-plaintext highlighter-rouge">fetch</code> to get the blob object of a local <code class="language-plaintext highlighter-rouge">photo.uri</code> and upload that to the signed upload URL. This caused a mismatch in the MD5 hash that expo calculated for the file and the blob I was actually uploading.</p>

<p>Eventually I used the <code class="language-plaintext highlighter-rouge">uploadAsync</code> method of the <code class="language-plaintext highlighter-rouge">expo-file-system</code> which uploads the contents of the file to the signed upload URL.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* FileSystem.FileInfo */</span>
<span class="kd">const</span> <span class="nx">meta</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nf">getInfoAsync</span><span class="p">(</span><span class="nx">photo</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="p">{</span> <span class="na">md5</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>

<span class="cm">/* Base 64 of the MD5 hash of the file */</span>
<span class="kd">const</span> <span class="nx">checksum</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">md5</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">)</span>

<span class="cm">/* Get the signed upload URL */</span>
<span class="kd">const</span> <span class="p">{</span>
  <span class="nx">blob_signed_id</span><span class="p">,</span>
  <span class="na">direct_upload</span><span class="p">:</span> <span class="p">{</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">url</span> <span class="p">},</span>
<span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/rails/active_storage/direct_uploads</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">file</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">filename</span><span class="p">:</span> <span class="dl">'</span><span class="s1">photo.jpeg</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">content_type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">image/jpeg</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">byte_size</span><span class="p">:</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
      <span class="nx">checksum</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">})</span>

<span class="cm">/* Upload the file */</span>
<span class="k">await</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nf">uploadAsync</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">headers</span><span class="p">,</span>
  <span class="na">httpMethod</span><span class="p">:</span> <span class="dl">'</span><span class="s1">PUT</span><span class="dl">'</span><span class="p">,</span>
<span class="p">})</span>

</code></pre></div></div>

  </div><a class="u-url" href="/2020/12/31/upload-image-from-expo-camera-to-rubys-active-storage.md.html" hidden></a>
</article>
      </div>
    </main><footer>
    <data class="u-url" href="/"></data>
  
    <div class="wrapper">
  
      <div class="footer-col-wrapper">
        <div class="footer-col">
          <p class="feed-subscribe">
            <a href="http://localhost:4000/feed.xml">
              <svg class="svg-icon orange">
                <use xlink:href="/assets/rss.svg"></use>
              </svg><span>Subscribe</span>
            </a>
          </p>
      </div>
  
    </div>
  
  </footer></body>

</html>